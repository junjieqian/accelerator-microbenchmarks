apiVersion: v1
kind: Pod
metadata:
  generateName: tpu7x-single-host-microbenchmark-
spec:
  restartPolicy: Never
  nodeSelector:
    cloud.google.com/gke-tpu-accelerator: tpu7x
    cloud.google.com/gke-tpu-topology: 2x2x1
  containers:
  - name: tpu-job
    image: python:3.12
    ports:
    - containerPort: 8431
    securityContext:
      privileged: false
    command:
    - bash
    - -c
    - |
      set -ex
      # install gcloud package
      apt-get update && apt-get install -y apt-transport-https ca-certificates gnupg
      curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | gpg --dearmor -o /usr/share/keyrings/cloud.google.gpg
      echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
      apt-get update && apt-get install -y google-cloud-cli

      git clone https://github.com/AI-Hypercomputer/accelerator-microbenchmarks.git
      cd accelerator-microbenchmarks
      pip install -r requirements.txt

      sh ./Ironwood/scripts/run_training_compute_microbenchmark.sh

      gcloud storage cp ../microbenchmarks/gemm_multiple_run_bf16/*.tsv gs://${BUCKET_NAME}/microbenchmarks/gemm_multiple_run_bf16/
      gcloud storage cp ../microbenchmarks/gemm_multiple_run_fp8/*.tsv gs://${BUCKET_NAME}/microbenchmarks/gemm_multiple_run_fp8/
      gcloud storage cp ../microbenchmarks/gemm_simple/*.tsv gs://${BUCKET_NAME}/microbenchmarks/gemm_simple/
      gcloud storage cp ../microbenchmarks/gemm/*.tsv gs://${BUCKET_NAME}/microbenchmarks/gemm/
      gcloud storage cp ../microbenchmarks/gemm_accum/*.tsv gs://${BUCKET_NAME}/microbenchmarks/gemm_accum/
      gcloud storage cp ../microbenchmarks/gemm_fp8_rowwise/*.tsv gs://${BUCKET_NAME}/microbenchmarks/gemm_fp8_rowwise/
      gcloud storage cp ../microbenchmarks/add/*.tsv gs://${BUCKET_NAME}/microbenchmarks/add/
      gcloud storage cp ../microbenchmarks/quantization/*.tsv gs://${BUCKET_NAME}/microbenchmarks/quantization/
      gcloud storage cp ../microbenchmarks/transpose_quantization/*.tsv gs://${BUCKET_NAME}/microbenchmarks/transpose_quantization/

    resources:
      requests:
        google.com/tpu: 4
      limits:
        google.com/tpu: 4